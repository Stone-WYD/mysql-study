{"objectClass":"NSDictionary","root":{"objectClass":"MindNode","ID":"6723H","children":{"0":{"objectClass":"MindNode","ID":"524G6","children":{"0":{"objectClass":"MindNode","ID":"DC5V2","text":"undo日志类型会被存放到FIL_PAGE_UNDO_LOG类型的页面中"},"objectClass":"NSArray"},"text":"日志格式","shrink":true},"1":{"objectClass":"MindNode","ID":"M1NNR","children":{"0":{"objectClass":"MindNode","ID":"LIOS5","children":{"0":{"objectClass":"MindNode","ID":"0X6I3","text":"TRX_UNDO_INSERT_REC"},"1":{"objectClass":"MindNode","ID":"S65J9","text":"该undo操作，只要保存下新增记录的主键，undo时按主键删除即可"},"2":{"objectClass":"MindNode","ID":"E6E5V","children":{"0":{"objectClass":"MindNode","ID":"MEKS9","text":"end of record"},"1":{"ID":"LDXWD","objectClass":"MindNode","children":{"0":{"objectClass":"MindNode","ID":"NX7F8","text":"TRX_UNDO_INSERT_REC"},"objectClass":"NSArray"},"text":"undo type"},"2":{"ID":"S4K4U","objectClass":"MindNode","children":{"0":{"objectClass":"MindNode","ID":"Y80D6","text":"从0开始递增的id"},"objectClass":"NSArray"},"text":"undo no"},"3":{"objectClass":"MindNode","ID":"6ZKMN","text":"table id"},"4":{"objectClass":"MindNode","ID":"O7O79","text":"主键各列信息，<len, value>列表"},"5":{"objectClass":"MindNode","ID":"XSJSS","text":"start of record"},"objectClass":"NSArray"},"text":"结构","shrink":true},"objectClass":"NSArray"},"text":"insert操作对应的undo日志"},"1":{"objectClass":"MindNode","ID":"5ZL57","children":{"0":{"objectClass":"MindNode","ID":"4G7Q6","text":"TRX_UNDO_DEL_MARK_REC"},"1":{"ID":"5SGWD","objectClass":"MindNode","children":{"0":{"objectClass":"MindNode","ID":"6ICFL","text":"mark为中间状态"},"1":{"objectClass":"MindNode","ID":"RE0OR","text":"真正删除，加入垃圾链中"},"objectClass":"NSArray"},"text":"过程"},"2":{"ID":"6ANN4","objectClass":"MindNode","children":{"0":{"objectClass":"MindNode","ID":"84PBG","text":"插入新记录时，只比较垃圾链第一条记录跟新纪录大小，垃圾链第一条大则放入垃圾链第一条记录处，然后垃圾链头指向第二条"},"1":{"objectClass":"MindNode","ID":"BR388","text":"当页面快满时，会比较剩余空间和垃圾链大小，然后重新组织页面"},"objectClass":"NSArray"},"text":"垃圾链补充："},"3":{"ID":"81601","objectClass":"MindNode","children":{"0":{"objectClass":"MindNode","ID":"H1R4X","text":"end of record"},"1":{"objectClass":"MindNode","ID":"89G95","text":"undo type"},"2":{"objectClass":"MindNode","ID":"3ANF7","text":"undo no"},"3":{"objectClass":"MindNode","ID":"T9YOH","text":"table id"},"4":{"objectClass":"MindNode","ID":"RXWVY","text":"info bits"},"5":{"ID":"02WOL","objectClass":"MindNode","children":{"0":{"ID":"SBR4T","objectClass":"MindNode","style2":{"objectClass":"NSDictionary","color":"#FF0000"},"text":"保存记录的trx_id字段，判断记录之前的操作是否在当前事务中进行，如果是会通过roll_pointer形成版本链"},"objectClass":"NSArray"},"text":"trx_id"},"6":{"ID":"KSJK0","objectClass":"MindNode","children":{"0":{"ID":"P8DUE","objectClass":"MindNode","style2":{"objectClass":"NSDictionary","color":"#FF0000"},"text":"保存记录的roll_pointer字段"},"objectClass":"NSArray"},"text":"roll_pointer"},"7":{"ID":"G4YMT","objectClass":"MindNode","children":{"0":{"objectClass":"MindNode","ID":"O2STT","text":"<len, value>"},"objectClass":"NSArray"},"text":"主键各列信息"},"8":{"objectClass":"MindNode","ID":"L46LX","text":"记录本部分和下一部分占用的存储空间大小"},"9":{"ID":"6SMA5","objectClass":"MindNode","children":{"0":{"objectClass":"MindNode","ID":"1G4ZH","text":"<pos, len, value>"},"objectClass":"NSArray"},"text":"索引各列信息"},"10":{"objectClass":"MindNode","ID":"78BD4","text":"start of record"},"objectClass":"NSArray"},"text":"结构"},"4":{"ID":"5OSHU","objectClass":"MindNode","style2":{"objectClass":"NSDictionary","color":"#FF0000"},"text":"roll_pointer可形成版本链"},"objectClass":"NSArray"},"text":"delete操作对应的undo日志","shrink":true},"2":{"objectClass":"MindNode","ID":"44KH8","children":{"0":{"objectClass":"MindNode","ID":"VFI22","children":{"0":{"objectClass":"MindNode","ID":"Z72KO","children":{"0":{"objectClass":"MindNode","ID":"A241B","text":"更新前后记录所占字节数不变"},"objectClass":"NSArray"},"text":"就地更新"},"1":{"objectClass":"MindNode","ID":"2Y6TG","children":{"0":{"objectClass":"MindNode","ID":"LSW65","children":{"0":{"objectClass":"MindNode","ID":"513T0","text":"增加一个TRX_UNDO_ DEL_MARK_REC日志"},"objectClass":"NSArray"},"text":"删除：直接加到垃圾链，没有mark阶段","style2":{"objectClass":"NSDictionary","color":"#FF0000"}},"1":{"objectClass":"MindNode","ID":"11C4S","children":{"0":{"objectClass":"MindNode","ID":"B0VS4","text":"如果新记录比旧记录小，则直接利用垃圾链第一条记录（就是刚删的旧记录）"},"1":{"objectClass":"MindNode","ID":"R6WCQ","text":"否则就正常新增一条记录"},"2":{"objectClass":"MindNode","ID":"LUE33","text":"增加一个TRX_UNDO_UPD_EXIST_REC日志记录","maxWidthLine":335.46875},"objectClass":"NSArray"},"text":"新增"},"objectClass":"NSArray"},"text":"先删除旧记录，再插入新纪录"},"2":{"objectClass":"MindNode","ID":"5FH57","children":{"0":{"objectClass":"MindNode","ID":"ZND9Y","text":"","imageName":"7987X4675B.png","imageSize":{"objectClass":"CGSize","width":852,"height":760},"imageResize":{"objectClass":"CGSize","width":408,"height":363.943661971831}},"objectClass":"NSArray"},"text":"结构"},"objectClass":"NSArray"},"text":"不更新主键"},"1":{"objectClass":"MindNode","ID":"87J2C","children":{"0":{"objectClass":"MindNode","ID":"S5614","children":{"0":{"objectClass":"MindNode","ID":"L0526","text":"新增一个TRX_UNDO_DEL_MARK_REC日志记录","maxWidthLine":335.984375},"objectClass":"NSArray"},"text":"将旧纪录delete mark(假删除，只是mark了一下)","maxWidthLine":340.65625,"style2":{"objectClass":"NSDictionary","color":"#FF0000"}},"1":{"objectClass":"MindNode","ID":"51O63","children":{"0":{"objectClass":"MindNode","ID":"862PW","text":"增加一个TRX_UNDO_UPD_EXIST_REC日志记录","maxWidthLine":335.46875},"objectClass":"NSArray"},"text":"根据更新后各列的值创建一条新纪录，\n并将其插入到聚簇索引中"},"objectClass":"NSArray"},"text":"更新主键"},"objectClass":"NSArray"},"text":"update操作对应的undo日志"},"3":{"objectClass":"MindNode","ID":"DRZ2J","children":{"0":{"objectClass":"MindNode","ID":"2E0P7","text":"二级索引的操作基本跟聚簇索引一致，操作完聚簇索引，当需要操作二级索引时，使用类似的操作来完成即可"},"1":{"objectClass":"MindNode","ID":"4UP9B","text":"如果对二级索引进行了修改，则被影响到的二级索引记录的页面的PAGE_MAX_TRX_ID会该百年"},"objectClass":"NSArray"},"text":"增删改对二级索引的影响"},"objectClass":"NSArray"},"text":"各种不同的undo日志"},"2":{"objectClass":"MindNode","ID":"82EBA","children":{"0":{"objectClass":"MindNode","ID":"3JWYC","text":"","imageName":"IPNVX3FY84.png","imageSize":{"objectClass":"CGSize","width":1000,"height":289},"imageResize":{"objectClass":"CGSize","width":343,"height":99.127}},"1":{"objectClass":"MindNode","ID":"QRIE9","text":"链表每个节点通过页号和页内偏移量都可以很快地找到对应的下一个节点或上一个节点"},"objectClass":"NSArray"},"text":"通用链表结构"},"3":{"objectClass":"MindNode","ID":"DK738","children":{"0":{"objectClass":"MindNode","ID":"YLU33","children":{"0":{"objectClass":"MindNode","ID":"H5P7H","children":{"0":{"objectClass":"MindNode","ID":"FQQ8O","text":"TRX_UNDO_INSERT"},"1":{"objectClass":"MindNode","ID":"HE53V","text":"TRX_UNDO_UPATE"},"2":{"objectClass":"MindNode","ID":"C654M","text":"区分原因：插入不需要考虑MVCC，其他操作需要","maxWidthLine":343.875},"objectClass":"NSArray"},"text":"TRX_UNDO_PAGE_TYPE","remark":"undo日志类型，此处指大类","remarkDisplay":true},"1":{"objectClass":"MindNode","ID":"JC2BD","children":{"0":{"objectClass":"MindNode","ID":"5RGC2","text":"从什么位置开始记录undo日志"},"objectClass":"NSArray"},"text":"TRX_UNDO_PAGE_START"},"2":{"objectClass":"MindNode","ID":"1BSKR","children":{"0":{"objectClass":"MindNode","ID":"1X3GS","text":"最后一条undo日志结束时的偏移量，也就下一条undo日志可以写入的位置"},"objectClass":"NSArray"},"text":"TRX_UNDO_PAGE_FREE"},"3":{"objectClass":"MindNode","ID":"34HXR","children":{"0":{"objectClass":"MindNode","ID":"XXHES","text":"代表一个链表节点结构"},"objectClass":"NSArray"},"text":"TRX_UNDO_PAGE_NODE"},"objectClass":"NSArray"},"text":"Undo Page Header结构"},"1":{"objectClass":"MindNode","ID":"DX4KS","text":"其他位置存放undo日志"},"2":{"objectClass":"MindNode","ID":"ZNBPK","text":"文件头"},"3":{"objectClass":"MindNode","ID":"9512Q","text":"文件尾"},"objectClass":"NSArray"},"text":"FIL_PAGE_UNDO_LOG页面"},"4":{"objectClass":"MindNode","ID":"BC0J8","children":{"0":{"objectClass":"MindNode","ID":"71PY3","text":"链表的第一个页面除了会有undo page header结构外，还有一些额外的管理信息","maxWidthLine":326.34375},"1":{"objectClass":"MindNode","ID":"137UG","text":"","imageName":"S387O6W578.png","imageSize":{"objectClass":"CGSize","width":920,"height":511}},"2":{"objectClass":"MindNode","ID":"UZD6L","children":{"0":{"objectClass":"MindNode","ID":"SW3O1","children":{"0":{"objectClass":"MindNode","ID":"NR26A","children":{"0":{"objectClass":"MindNode","ID":"FFM18","text":"undo页面所处的状态"},"objectClass":"NSArray"},"text":"TRX_UNDO_STATE"},"1":{"objectClass":"MindNode","ID":"KQ87V","children":{"0":{"objectClass":"MindNode","ID":"0W7K9","text":"本undo页面链表中最后一个Undo Log Header 的位置"},"objectClass":"NSArray"},"text":"TRX_UNDO_LAST_LOG"},"2":{"objectClass":"MindNode","ID":"V9S0M","children":{"0":{"objectClass":"MindNode","ID":"4HLW8","text":"本undo页面链表对应的段信息"},"objectClass":"NSArray"},"text":"TRX_UNDO_FSEG_HEADER"},"3":{"objectClass":"MindNode","ID":"V1K96","children":{"0":{"objectClass":"MindNode","ID":"GB3GW","text":"undo页面链表的基节点"},"objectClass":"NSArray"},"text":"TRX_UNDO_PAGE_LIST"},"objectClass":"NSArray"},"text":"Undo Log Segment Header","remark":"段信息：此处的段指的是undo log数据的段，而不是某个表的段，因为一个事务可能操作了多个表","remarkDisplay":true},"1":{"objectClass":"MindNode","ID":"4JPV2","text":"Undo Log Header","remark":"对当前分组undo log链的说明","remarkDisplay":true},"objectClass":"NSArray"},"text":"链表头节点多出的管理信息：","remark":"一个undo链表是跟一个段绑定的","remarkDisplay":true},"objectClass":"NSArray"},"text":"Undo页面链表"},"5":{"objectClass":"MindNode","ID":"H1QD5","children":{"0":{"objectClass":"MindNode","ID":"V66SE","children":{"0":{"objectClass":"MindNode","ID":"SGO24","text":"链表只有一个页面"},"1":{"objectClass":"MindNode","ID":"75HJD","text":"一个页面中已使用的部分占比不到3/4"},"objectClass":"NSArray"},"text":"重用条件"},"1":{"objectClass":"MindNode","ID":"BJ1U7","children":{"0":{"objectClass":"MindNode","ID":"4SK73","children":{"0":{"objectClass":"MindNode","ID":"EE2OW","text":"日志提交后就没什么用了，可以直接覆盖掉"},"objectClass":"NSArray"},"text":"insert undo 链表"},"1":{"objectClass":"MindNode","ID":"NK422","children":{"0":{"objectClass":"MindNode","ID":"Q5DID","text":"不能直接覆盖，会接着完后写入"},"objectClass":"NSArray"},"text":"update undo 链表"},"objectClass":"NSArray"},"text":"重用策略"},"objectClass":"NSArray"},"text":"Undo页面的重用"},"6":{"objectClass":"MindNode","ID":"WE46D","children":{"0":{"objectClass":"MindNode","ID":"G3FVR","text":"一个回滚段占一个页面大小"},"1":{"objectClass":"MindNode","ID":"3661I","children":{"0":{"objectClass":"MindNode","ID":"F93OS","children":{"0":{"objectClass":"MindNode","ID":"JC645","text":"first undo page是班长"},"1":{"objectClass":"MindNode","ID":"RYGS4","text":"其他节点是普通同学"},"objectClass":"NSArray"},"text":"一个undo log 链是一个班"},"1":{"objectClass":"MindNode","ID":"2MJK5","text":"Rollback Segment Header是个会议室，把班长都召集在一起，传达会议精神"},"objectClass":"NSArray"},"text":"一个比喻"},"2":{"objectClass":"MindNode","ID":"3ISBJ","text":"通过TRX_RSEG_FSEG_HEADER，\n回滚段可以找到对应的段"},"3":{"objectClass":"MindNode","ID":"7YS24","text":"","imageName":"X5NLSK8LLW.png","imageSize":{"objectClass":"CGSize","width":1057,"height":603},"imageResize":{"objectClass":"CGSize","width":236,"height":134.63386944181644}},"4":{"objectClass":"MindNode","ID":"I6WQ6","children":{"0":{"objectClass":"MindNode","ID":"RA836","text":"is_insert：是否是insert日志"},"1":{"objectClass":"MindNode","ID":"JV3N2","text":"rseg_id：回滚段编号"},"2":{"objectClass":"MindNode","ID":"22717","text":"page number：undo日志所在页号"},"3":{"objectClass":"MindNode","ID":"Q637A","text":"offset：undo日志在页中的偏移量"},"objectClass":"NSArray"},"text":"聚簇索引记录的roll_pointer"},"objectClass":"NSArray"},"text":"回滚段Rollback Segment Header"},"7":{"objectClass":"MindNode","ID":"HEJV5","children":{"0":{"objectClass":"MindNode","ID":"WH661","text":"","imageName":"JM0KJVNHYS.png","imageSize":{"objectClass":"CGSize","width":1090,"height":681}},"1":{"objectClass":"MindNode","ID":"0Y724","text":"","imageName":"P92N5432G6.png","imageSize":{"objectClass":"CGSize","width":1100,"height":450}},"objectClass":"NSArray"},"text":"为事务分配Undo页面链表的详细过程"},"objectClass":"NSArray"},"text":"undo日志"},"ID":"UAGJP","style":100,"lineKeepThin":true}