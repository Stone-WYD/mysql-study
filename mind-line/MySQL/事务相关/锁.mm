{"objectClass":"NSDictionary","root":{"objectClass":"MindNode","ID":"KY874","children":{"0":{"objectClass":"MindNode","ID":"M2243","children":{"0":{"objectClass":"MindNode","ID":"D7351","text":"写操作时会加锁"},"1":{"objectClass":"MindNode","ID":"5U444","children":{"0":{"objectClass":"MindNode","ID":"577O1","text":"一个与事务和记录相关联的内存结构"},"1":{"objectClass":"MindNode","ID":"3CK79","text":"trx信息：加锁事务"},"2":{"objectClass":"MindNode","ID":"S43K8","text":"is_waiting: 加锁的事务是否在阻塞中"},"objectClass":"NSArray"},"text":"锁","shrink":true},"2":{"objectClass":"MindNode","ID":"W0OG7","children":{"0":{"objectClass":"MindNode","ID":"037G2","text":"事务 t1发现记录 i 没有关联的锁结构，则创建锁 lock1(is_waiting = false) 与之关联，然后对记录进行修改操作"},"1":{"objectClass":"MindNode","ID":"31SO3","text":"事务 t2 发现记录 i 有关联的锁结构，则创建锁 lock2(is_waiting = trur) 与之关联，然后阻塞 "},"2":{"objectClass":"MindNode","ID":"H6351","text":"t1 运行结束，发现有其他锁与记录绑定，唤醒其他事务( 将 is_waiting 设为 true )"},"objectClass":"NSArray"},"text":"加锁解锁过程","shrink":true},"objectClass":"NSArray"},"text":"写"},"1":{"objectClass":"MindNode","ID":"N4JJ8","children":{"0":{"objectClass":"MindNode","ID":"17T3N","children":{"0":{"objectClass":"MindNode","ID":"74YMV","text":"MVCC"},"objectClass":"NSArray"},"text":"一致性读"},"1":{"objectClass":"MindNode","ID":"VV188","children":{"0":{"objectClass":"MindNode","ID":"79C89","children":{"0":{"objectClass":"MindNode","ID":"KRCQ8","text":"共享锁（读锁）：S锁"},"1":{"objectClass":"MindNode","ID":"526W3","text":"独占锁（排他锁，写锁）：X 锁"},"objectClass":"NSArray"},"text":"共享锁和独占锁"},"1":{"objectClass":"MindNode","ID":"OOYON","children":{"0":{"objectClass":"MindNode","ID":"8IZGE","text":"select ... lock in share mode;"},"1":{"objectClass":"MindNode","ID":"D54WW","text":"select ... for update;"},"objectClass":"NSArray"},"text":"锁定读的语句"},"objectClass":"NSArray"},"text":"锁定读","shrink":true},"objectClass":"NSArray"},"text":"读"},"2":{"objectClass":"MindNode","ID":"G554B","children":{"0":{"objectClass":"MindNode","ID":"UO05U","children":{"0":{"objectClass":"MindNode","ID":"5D8K4","text":"先获取记录位置"},"1":{"objectClass":"MindNode","ID":"QKH3Y","text":"获取X锁"},"2":{"objectClass":"MindNode","ID":"6E17J","text":"执行 delete mark "},"objectClass":"NSArray"},"text":"DELETE","shrink":true},"1":{"objectClass":"MindNode","ID":"211UB","children":{"0":{"objectClass":"MindNode","ID":"2VVX8","children":{"0":{"objectClass":"MindNode","ID":"85H24","text":"先获取记录位置"},"1":{"objectClass":"MindNode","ID":"0QO87","text":"获取X锁"},"2":{"objectClass":"MindNode","ID":"Y8O3E","text":"原地更改"},"objectClass":"NSArray"},"text":"原地更改"},"1":{"objectClass":"MindNode","ID":"P76UM","children":{"0":{"objectClass":"MindNode","ID":"PE159","text":"获取记录位置"},"1":{"objectClass":"MindNode","ID":"KEV9U","text":"获取X锁"},"2":{"objectClass":"MindNode","ID":"65569","text":"直接删除记录（放入垃圾链）"},"3":{"objectClass":"MindNode","ID":"1M4D5","text":"插入新的记录"},"objectClass":"NSArray"},"text":"未修改键值"},"2":{"objectClass":"MindNode","ID":"Y2F68","children":{"0":{"objectClass":"MindNode","ID":"571N9","text":"先delete"},"1":{"objectClass":"MindNode","ID":"3M4H5","text":"再插入新记录"},"objectClass":"NSArray"},"text":"修改键值"},"objectClass":"NSArray"},"text":"UPDATE","shrink":true},"2":{"objectClass":"MindNode","ID":"6WGT4","children":{"0":{"objectClass":"MindNode","ID":"3HT3E","text":"插入一条记录受隐式锁保护，不需要加锁"},"objectClass":"NSArray"},"text":"INSERT"},"objectClass":"NSArray"},"text":"写操作"},"3":{"objectClass":"MindNode","ID":"U52JT","children":{"0":{"objectClass":"MindNode","ID":"0R9QT","children":{"0":{"objectClass":"MindNode","ID":"R99HX","children":{"0":{"objectClass":"MindNode","ID":"4K26O","text":"如果有意向锁则会等待"},"objectClass":"NSArray"},"text":"S"},"1":{"objectClass":"MindNode","ID":"23N26","children":{"0":{"objectClass":"MindNode","ID":"V14SY","text":"如果有意向锁则会等待"},"objectClass":"NSArray"},"text":"X"},"2":{"objectClass":"MindNode","ID":"XMEY7","children":{"0":{"objectClass":"MindNode","ID":"Q11UE","text":"IS"},"1":{"objectClass":"MindNode","ID":"12J9O","text":"IX"},"objectClass":"NSArray"},"text":"意向锁"},"objectClass":"NSArray"},"text":"表级锁","shrink":true},"1":{"objectClass":"MindNode","ID":"91E77","children":{"0":{"objectClass":"MindNode","ID":"R8807","children":{"0":{"objectClass":"MindNode","ID":"NPC44","text":"对行上锁前会加意向锁IS"},"1":{"objectClass":"MindNode","ID":"80L2Y","text":"不关心是否有其他意向锁"},"objectClass":"NSArray"},"text":"S"},"1":{"objectClass":"MindNode","ID":"079D7","children":{"0":{"objectClass":"MindNode","ID":"RV2V8","text":"对行上锁前会加意向锁IX"},"1":{"objectClass":"MindNode","ID":"4M84D","text":"不关心是否有其他意向锁"},"objectClass":"NSArray"},"text":"X"},"objectClass":"NSArray"},"text":"行级锁","shrink":true},"objectClass":"NSArray"},"text":"多粒度锁"},"4":{"objectClass":"MindNode","ID":"38HOG","children":{"0":{"objectClass":"MindNode","ID":"3R5I4","children":{"0":{"objectClass":"MindNode","ID":"31589","children":{"0":{"objectClass":"MindNode","ID":"H31XK","text":"执行SELECT、INSERT、DELETE、UPDATE\n语句时，不会加锁"},"1":{"objectClass":"MindNode","ID":"88864","text":"进行ALTER TABLE、DROP TABLE等的DDL语句时，会加表锁，增删改查或者事务会被阻塞；事务未提交时，DDL操作也会被阻塞"},"2":{"objectClass":"MindNode","ID":"25JH0","children":{"0":{"objectClass":"MindNode","ID":"5NMU2","text":"LOCK TABLE t READ 给t加表级别S锁"},"1":{"objectClass":"MindNode","ID":"IF66R","text":"LOCK TABLE t WRITE 给t加表级别X锁"},"objectClass":"NSArray"},"text":"手动加表级锁没什么意义"},"objectClass":"NSArray"},"text":"标记别S、X锁"},"1":{"objectClass":"MindNode","ID":"L0J86","text":"表级别IS锁，IX锁"},"2":{"objectClass":"MindNode","ID":"GXPN3","children":{"0":{"objectClass":"MindNode","ID":"K352D","children":{"0":{"objectClass":"MindNode","ID":"P545X","text":"表中有这个锁时，一个事务插入时，其他事务的插入会被阻塞，以保证字段的自动递增"},"objectClass":"NSArray"},"text":"表级别AUTO-INC锁 "},"1":{"objectClass":"MindNode","ID":"U5ZB5","children":{"0":{"objectClass":"MindNode","ID":"83749","text":"确定一次插入需要插入多少数据，提前生成，可以避免锁表"},"objectClass":"NSArray"},"text":"使用轻量级锁"},"objectClass":"NSArray"},"text":"AUTO_INCREMENT修饰的列使用"},"objectClass":"NSArray"},"text":"表级锁","shrink":true},"1":{"objectClass":"MindNode","ID":"SNSYG","children":{"0":{"objectClass":"MindNode","ID":"614T1","children":{"0":{"objectClass":"MindNode","ID":"8Q4BG","text":"LOCK_REC_NOT_GAP: 正经锁"},"1":{"objectClass":"MindNode","ID":"49669","children":{"0":{"objectClass":"MindNode","ID":"17V1G","text":"上读锁其他事务可以读，不可以写"},"objectClass":"NSArray"},"text":"S型正经锁"},"2":{"objectClass":"MindNode","ID":"EIW1R","children":{"0":{"objectClass":"MindNode","ID":"56534","text":"上写锁其他事务不可以读，也不可以写"},"objectClass":"NSArray"},"text":"X型正经锁"},"objectClass":"NSArray"},"text":"RecordLock"},"1":{"objectClass":"MindNode","ID":"S7EML","children":{"0":{"objectClass":"MindNode","ID":"251NY","text":"LOCK_GAP"},"1":{"objectClass":"MindNode","ID":"OO963","text":"防止插入欢迎记录"},"2":{"objectClass":"MindNode","ID":"H7E4I","text":"对其他事务加锁没有影响"},"3":{"objectClass":"MindNode","ID":"65Q15","text":"给 Supremum记录加gap锁可以\n有效地防止幻影记录的插入","style2":{"objectClass":"NSDictionary","color":"#FF0000"}},"objectClass":"NSArray"},"text":"GapLock"},"2":{"objectClass":"MindNode","ID":"F43XT","children":{"0":{"objectClass":"MindNode","ID":"6XYRV","text":"LOCK_ORDINARY: next-key"},"1":{"objectClass":"MindNode","ID":"L6109","text":"本质：正经锁和 gap锁的合体"},"objectClass":"NSArray"},"text":"Next-Key Lock"},"3":{"objectClass":"MindNode","ID":"3HH3T","children":{"0":{"objectClass":"MindNode","ID":"IU64F","text":"LOCK_INSERT_INTENTION"},"1":{"objectClass":"MindNode","ID":"932SL","text":"插入意向锁：事务想插入的位置有gap锁时，等待的事务需要在内存中生成一个插入意向锁"},"2":{"objectClass":"MindNode","ID":"NL16L","text":"插入意向锁不会阻塞任何其他锁"},"objectClass":"NSArray"},"text":"Insert Intention Lock"},"4":{"objectClass":"MindNode","ID":"63663","children":{"0":{"objectClass":"MindNode","ID":"5850Y","text":"与显式锁的作用一样，但是不是由插入事务加上，而且会延迟加锁"},"1":{"objectClass":"MindNode","ID":"BFIL4","text":"其他事务对记录加锁前会查看记录trx_id，如果trx_id的事务处于活跃状态，则帮助该事务创建一个隐式锁，然后自己也创建一个锁，让自己等待"},"objectClass":"NSArray"},"text":"隐式锁"},"objectClass":"NSArray"},"text":"行级锁","shrink":true},"2":{"objectClass":"MindNode","ID":"Y234I","children":{"0":{"objectClass":"MindNode","ID":"V79CU","text":"","imageName":"JEC17Y252D.png","imageSize":{"objectClass":"CGSize","width":703,"height":458}},"1":{"objectClass":"MindNode","ID":"ULF4Y","text":"n_bits: 对行级锁来说，一条记录对应一个比特，用不同比特区分对哪条记录加的锁"},"2":{"objectClass":"MindNode","ID":"J9UU2","text":"一堆比特位：行级锁使用，记录上锁的记录（每个比特位会跟页面中的记录映射起来）"},"3":{"objectClass":"MindNode","ID":"IX6X3","children":{"0":{"objectClass":"MindNode","ID":"2WRUC","children":{"0":{"objectClass":"MindNode","ID":"22I3U","text":"在同一个事务中进行加锁操作"},"1":{"objectClass":"MindNode","ID":"X1703","text":"被加锁的记录在同一个页面中"},"2":{"objectClass":"MindNode","ID":"WWWN5","text":"加锁的类型一样"},"3":{"objectClass":"MindNode","ID":"RD5F5","text":"等待状态一样"},"objectClass":"NSArray"},"text":"多条记录用同一\n个锁的条件"},"objectClass":"NSArray"},"text":"因为使用了这种结构，所以一个页面\n内的多条记录，可以使用同一个锁"},"objectClass":"NSArray"},"text":"InnoDB锁的内存结构","shrink":true},"objectClass":"NSArray"},"text":"InnoDB存储引擎中的锁"},"5":{"objectClass":"MindNode","ID":"5H0MB","children":{"0":{"objectClass":"MindNode","ID":"H5NYD","text":"普通的SELECT语句"},"1":{"objectClass":"MindNode","ID":"4T157","children":{"0":{"objectClass":"MindNode","ID":"2VG31","text":"匹配模式：通过扫描区间去查询，如果扫描区间只有一个则为精确匹配"},"1":{"objectClass":"MindNode","ID":"6944C","text":"唯一性搜索：事先能确定结构只有一条记录的搜索"},"2":{"objectClass":"MindNode","ID":"SK3Z6","children":{"0":{"objectClass":"MindNode","ID":"84IN7","text":"在扫描区间中找到第一条记录作为当前记录"},"1":{"objectClass":"MindNode","ID":"096M9","children":{"0":{"objectClass":"MindNode","ID":"6NFWO","text":"隔离级别不大于 READ COMMITED，加正经锁","maxWidthLine":326},"1":{"objectClass":"MindNode","ID":"49T9Y","text":"隔离级别不小于 REPEATABLE COMMITED，加next-key锁","maxWidthLine":327.15625},"objectClass":"NSArray"},"text":"为当前记录加锁","remark":"二级索引记录或者聚簇索引记录","style2":{"objectClass":"NSDictionary","color":"#FF0000"},"remarkDisplay":true},"2":{"objectClass":"MindNode","ID":"7PS73","children":{"0":{"objectClass":"MindNode","ID":"F61Q2","children":{"0":{"objectClass":"MindNode","ID":"860S5","children":{"0":{"objectClass":"MindNode","ID":"535KJ","text":"直接返回“执行完毕”"},"objectClass":"NSArray"},"text":"不符合"},"objectClass":"NSArray"},"text":"当前记录是否符合边界条件"},"1":{"objectClass":"MindNode","ID":"6FR49","children":{"0":{"objectClass":"MindNode","ID":"O1412","text":"符合则执行下一个步骤"},"1":{"objectClass":"MindNode","ID":"3JH56","children":{"0":{"objectClass":"MindNode","ID":"B5B41","text":"去当前记录所在链表去下一条\n记录从上一个步骤继续执行"},"1":{"objectClass":"MindNode","ID":"FASCS","text":"此处可以发现，即使不符合下推条件，\n加在当前记录的锁并不会被释放掉","style2":{"objectClass":"NSDictionary","color":"#FF0000"}},"objectClass":"NSArray"},"text":"不符合"},"objectClass":"NSArray"},"text":"当前记录是否符合下推条件"},"2":{"objectClass":"MindNode","ID":"412F2","children":{"0":{"objectClass":"MindNode","ID":"6TVU1","text":"将服务层的工作下推给引擎层处理"},"1":{"objectClass":"MindNode","ID":"L34TT","text":"看where中的条件能否使用二级索引来判断，如果在二级索引处就能看到记录不满足条件，则不会再回表查找记录，直接开始判断下一条记录是否满足条件"},"2":{"objectClass":"MindNode","ID":"27354","text":"目的是为了减少回表的次数"},"3":{"objectClass":"MindNode","ID":"575E4","text":"仅适用于SELECT语句"},"objectClass":"NSArray"},"text":"补充：索引下推","style2":{"objectClass":"NSDictionary","color":"#FF0000"}},"objectClass":"NSArray"},"text":"判断索引条件下推的条件是否成立","remark":"聚簇索引不会走这一步","style2":{"objectClass":"NSDictionary","color":"#007AFF"},"remarkDisplay":true},"3":{"objectClass":"MindNode","ID":"PNV2T","children":{"0":{"objectClass":"MindNode","ID":"LNL6T","text":"回表后给对应的记录加锁，\n此处加的锁是正经锁","style2":{"objectClass":"NSDictionary","color":"#FF0000"}},"objectClass":"NSArray"},"text":"执行回表操作","remark":"聚簇索引不会走这一步","style2":{"objectClass":"NSDictionary","color":"#007AFF"},"remarkDisplay":true},"4":{"objectClass":"MindNode","ID":"7RBAR","children":{"0":{"objectClass":"MindNode","ID":"1158M","text":"不在就直接返回查询完毕"},"objectClass":"NSArray"},"text":"判断边界条件是否成立"},"5":{"objectClass":"MindNode","ID":"1OR3S","children":{"0":{"objectClass":"MindNode","ID":"OIG3D","text":"不成立会释放掉正经锁，但不会释放掉key-next锁","remark":"这里的锁指的是步骤二加的锁","maxWidthLine":356,"style2":{"objectClass":"NSDictionary","color":"#FF0000"},"remarkDisplay":true},"1":{"objectClass":"MindNode","ID":"WWWB8","text":"成立则不会释放锁并将结果返回给客户端"},"objectClass":"NSArray"},"text":"server曾判断其余搜索条件是否成立"},"6":{"objectClass":"MindNode","ID":"3B674","text":"继续获取下一条记录，从步骤二执行"},"objectClass":"NSArray"},"text":"步骤"},"3":{"objectClass":"MindNode","ID":"65V8V","text":"其他一些情况"},"objectClass":"NSArray"},"text":"锁定读的语句","shrink":true},"2":{"objectClass":"MindNode","ID":"48048","children":{"0":{"objectClass":"MindNode","ID":"Z3151","text":"锁定读使用锁性能会比较低"},"1":{"objectClass":"MindNode","ID":"1941O","text":"MVCC没有使用锁，使用版本链性能更高，但无法避免幻读"},"objectClass":"NSArray"},"text":"锁定读和MVCC都是避免脏写、脏读、不可重复读、幻读等现象的解决方案","style2":{"objectClass":"NSDictionary","color":"#FF0000"}},"3":{"objectClass":"MindNode","ID":"P6S8R","children":{"0":{"objectClass":"MindNode","ID":"M032V","text":"介于一致性读和锁定读之间"},"1":{"objectClass":"MindNode","ID":"OW4YJ","children":{"0":{"objectClass":"MindNode","ID":"G4561","text":"下一个版本如果匹配，则再次读该记录并加锁"},"1":{"objectClass":"MindNode","ID":"57K48","text":"不匹配则跳过该记录，查询下一条记录"},"objectClass":"NSArray"},"text":"读的时候如果碰到X锁，会去读下一个版本","shrink":true},"objectClass":"NSArray"},"text":"半一致性读"},"objectClass":"NSArray"},"text":"语句加锁分析"},"objectClass":"NSArray"},"text":"锁"},"ID":"3TM5C","style":100,"lineKeepThin":true}